#!/usr/bin/env bash
set -euo pipefail

# --- Progress-friendly environment for the Python builder ---
export TERM="${TERM:-xterm-256color}"
export PYTHONUTF8=1
export PYTHONUNBUFFERED=1
export FORCE_COLOR=1
export PANOPTES_NESTED_PROGRESS=1
# Build.ps1 handles PANOPTES_PROGRESS_ACTIVE during its own phases

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT="$(cd "$HERE/.." && pwd)"

# Drop optional leading token from subproject launchers (e.g., "argos")
if [[ "${1-}" == "argos" ]]; then shift; fi

PY="$(command -v python3 || command -v python)"
"$PY" "$ROOT/projects/argos/bootstrap.py" --ensure --yes --reinstall
VPY="$("$PY" "$ROOT/projects/argos/bootstrap.py" --print-venv)"

"$VPY" -m pip check
export PYTHONPYCACHEPREFIX="${XDG_CACHE_HOME:-$HOME/.cache}/rAIn/pycache"

# Add installers/ to PATH (session + profile) non-interactively
"$HERE/setup-path.sh" -y || true

exec "$VPY" -m panoptes.tools.build_models "$@"
