#!/usr/bin/env bash
set -euo pipefail

# --- Progress-friendly environment for the Python builder ---
export TERM="${TERM:-xterm-256color}"
export PYTHONUTF8=1
export PYTHONUNBUFFERED=1
export FORCE_COLOR=1
export PANOPTES_NESTED_PROGRESS=1

# Ensure final confirm is interactive (do NOT auto-accept)
unset ARGOS_ASSUME_YES || true

# Skip weight downloads during the non-interactive bootstrap step;
# the interactive model builder runs afterwards.
export ARGOS_SKIP_WEIGHTS=1

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT="$(cd "$HERE/.." && pwd)"

# Drop optional leading token from subproject launchers (e.g., "argos")
if [[ "${1-}" == "argos" ]]; then shift; fi

PY="$(command -v python3 || command -v python)"
BOOTSTRAP="$ROOT/projects/argos/bootstrap.py"

if ! "$PY" "$BOOTSTRAP" --ensure --yes --reinstall --with-dev --extras audio; then
  echo "Argos bootstrap failed. See logs above." >&2
  exit 1
fi

VPY="$("$PY" "$BOOTSTRAP" --print-venv)"
if [[ -z "$VPY" || ! -x "$VPY" ]]; then
  echo "Could not resolve Argos venv python." >&2
  exit 1
fi

VENV_ROOT="$(cd "$(dirname "$VPY")/.." && pwd)"
echo "[Argos] python: $VPY (venv=$VENV_ROOT)"
export PANOPTES_VENV_ROOT="$VENV_ROOT"

"$VPY" -m panoptes.live.backend_controller --force || true

"$VPY" -m pip check || true
export PYTHONPYCACHEPREFIX="${XDG_CACHE_HOME:-$HOME/.cache}/rAIn/pycache"

# Add installers/ to PATH (session + profile) non-interactively
"$HERE/setup-path.sh" -y || true

# IMPORTANT: Do NOT auto-feed "1" unless explicitly requested by the user.
build_status=0
"$VPY" -m panoptes.tools.build_models "$@" || build_status=$?

if [[ $build_status -eq 0 ]]; then
  "$VPY" -m compileall "$ROOT/projects/argos" || build_status=$?
  exit $build_status
fi

# Treat user exit (Typer Exit -> 1) as a no-op so the command ends quietly.
if [[ $build_status -eq 1 ]]; then
  exit 0
fi

exit $build_status
