#!/usr/bin/env bash
set -euo pipefail

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT="$(cd "$HERE/.." && pwd)"
PROJ_DIR="$ROOT/projects"

ensure_git_lfs() {
  if command -v git >/dev/null 2>&1; then
    if git lfs version >/dev/null 2>&1; then
      git -C "$ROOT" lfs install --local >/dev/null 2>&1 || true
      GIT_LFS_SKIP_SMUDGE=0 git -C "$ROOT" lfs pull >/dev/null 2>&1 || true
    else
      echo "⚠️ Git LFS not installed. Large files (models) may be missing."
      echo "   Install Git LFS and re-run this command."
    fi
  fi
}

proj=""; tokens=(); saw_build=0
while (($#)); do
  t="$1"; shift
  lt="${t,,}"
  case "$lt" in
    run|me) ;;
    build|package|pack) saw_build=1 ;;
    argos|argos:run|run:argos|argos:build|build:argos) proj="argos" ;;
    *) tokens+=("$t") ;;
  esac
done

cwd="$(pwd)"
if [[ -z "${proj:-}" ]]; then
  case "$cwd" in *"/projects/argos"*) proj="argos" ;; esac
fi
if [[ -z "${proj:-}" ]]; then
  if [[ "$cwd" == "$ROOT" || "$cwd" == "$PROJ_DIR" ]]; then
    echo "Specify the project:  run argos  |  argos [args]" >&2
    exit 2
  fi
fi

ensure_git_lfs

normalize_tokens() {
  local -a in=("$@") out=()
  local op="" op_idx=-1 tok low
  for i in "${!in[@]}"; do
    tok="${in[$i]}"; low="${tok,,}"
    case "$low" in
      d|detect|-d|--detect) op="d"; op_idx=$i; break ;;
      hm|heatmap|-hm|--hm|-heatmap|--heatmap) op="hm"; op_idx=$i; break ;;
      gj|geojson|-gj|--gj|-geojson|--geojson) op="gj"; op_idx=$i; break ;;
      *) ;;
    esac
  done
  if [[ "$op_idx" -gt 0 ]]; then
    out+=("$op")
    for j in "${!in[@]}"; do [[ $j -ne $op_idx ]] && out+=("${in[$j]}"); done
    in=("${out[@]}")
  fi
  printf '%s\n' "${in[@]}"
}
mapfile -t tokens < <(normalize_tokens "${tokens[@]}")

if [[ "$saw_build" -eq 1 ]]; then
  exec "$ROOT/installers/build" "$proj" "${tokens[@]}"
fi

if [[ "$proj" == "argos" ]]; then
  PY="$(command -v python3 || command -v python)"
  "$PY" "$ROOT/projects/argos/bootstrap.py" --ensure --yes >/dev/null 2>&1 || true
  VPY="$("$PY" "$ROOT/projects/argos/bootstrap.py" --print-venv)"
  export PYTHONPYCACHEPREFIX="${XDG_CACHE_HOME:-$HOME/.cache}/rAIn/pycache"
  exec "$VPY" -m panoptes.cli "${tokens[@]}"
fi

echo "Unknown project: $proj" >&2
exit 2
